/**

 * BACKEND WORKER SMAN 2 CIKARANG BARAT

 * Database: perpustakaan-db | Binding: DB

 */



export default {

  async fetch(request, env) {

    const url = new URL(request.url);

    const DB = env.DB;

    const corsHeaders = {

      "Access-Control-Allow-Origin": "*",

      "Access-Control-Allow-Methods": "GET, POST, OPTIONS",

      "Access-Control-Allow-Headers": "Content-Type, Authorization",

      "Content-Type": "application/json"

    };



    if (request.method === "OPTIONS") return new Response(null, { headers: corsHeaders });



    // API LOGIN

    if (url.pathname === "/api/login" && request.method === "POST") {

      try {

        const body = await request.json();

        const admin = await DB.prepare("SELECT * FROM admin WHERE user = ? AND pwd = ?")

          .bind(body.user, body.pwd).first();

        return new Response(JSON.stringify({ success: !!admin }), { headers: corsHeaders });

      } catch (e) {

        return new Response(JSON.stringify({ error: "Auth Error" }), { status: 500, headers: corsHeaders });

      }

    }



    // API DATA BUKU - Urut Tanggal Input Terbaru

    if (url.pathname === "/api/buku" && request.method === "GET") {

      try {

        const { results } = await DB.prepare("SELECT * FROM buku ORDER BY tanggal_input DESC").all();

        return new Response(JSON.stringify(results), { headers: corsHeaders });

      } catch (e) {

        return new Response(JSON.stringify({ error: e.message }), { status: 500, headers: corsHeaders });

      }

    }



    // API DATA ANGGOTA

    if (url.pathname === "/api/anggota" && request.method === "GET") {

      try {

        const { results } = await DB.prepare("SELECT * FROM anggota ORDER BY nama_lengkap ASC").all();

        return new Response(JSON.stringify(results), { headers: corsHeaders });

      } catch (e) {

        return new Response(JSON.stringify({ error: e.message }), { status: 500, headers: corsHeaders });

      }

    }



    return new Response("API SMAN 2 CIKARANG BARAT Online", { status: 200, headers: corsHeaders });

  }

};
