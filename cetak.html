<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D1 Database Explorer</title>
    <style>
        /* Styles tetap sama seperti sebelumnya */
        /* ... semua CSS dari versi sebelumnya ... */
    </style>
</head>
<body>
    <!-- HTML struktur tetap sama -->
    <!-- ... semua HTML dari versi sebelumnya ... -->

    <script>
        // Konfigurasi API endpoint
        const API_BASE_URL = '/api'; // Gunakan relative path untuk same-origin
        
        // Fungsi untuk panggil API
        async function callAPI(endpoint, method = 'GET', data = null) {
            const url = `${API_BASE_URL}${endpoint}`;
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                },
            };
            
            if (data && (method === 'POST' || method === 'PUT')) {
                options.body = JSON.stringify(data);
            }
            
            try {
                const response = await fetch(url, options);
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || `HTTP ${response.status}`);
                }
                
                return result;
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }
        
        // Fungsi untuk mendapatkan daftar tabel
        async function fetchTables() {
            try {
                const result = await callAPI('/tables');
                displayTables(result.data);
            } catch (error) {
                showError(`Gagal mengambil daftar tabel: ${error.message}`);
            }
        }
        
        // Fungsi untuk mendapatkan deskripsi tabel
        async function fetchTableSchema(tableName) {
            try {
                const result = await callAPI(`/table/${tableName}`);
                displayTableSchema(result.data);
            } catch (error) {
                showError(`Gagal mengambil schema tabel: ${error.message}`);
            }
        }
        
        // Fungsi untuk eksekusi query
        async function executeQuery(sql, params = []) {
            try {
                const result = await callAPI('/query', 'POST', {
                    sql,
                    params,
                    limit: document.getElementById('limitResults').value
                });
                displayQueryResults(result);
            } catch (error) {
                showError(`Gagal eksekusi query: ${error.message}`);
            }
        }
        
        // Fungsi untuk mendapatkan data tabel
        async function fetchTableData(tableName, page = 1) {
            try {
                const result = await callAPI(`/data/${tableName}?page=${page}&limit=50`);
                displayTableData(result.data);
            } catch (error) {
                showError(`Gagal mengambil data tabel: ${error.message}`);
            }
        }
        
        // Update event listeners di DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function() {
            // ... kode yang ada ...
            
            // Ganti worker dengan API calls
            executeBtn.addEventListener('click', async function() {
                const action = actionType.value;
                const tableName = tableNameInput.value.trim();
                const query = sqlQueryInput.value.trim();
                
                executeBtn.disabled = true;
                executeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses...';
                
                try {
                    switch (action) {
                        case 'listTables':
                            await fetchTables();
                            break;
                            
                        case 'describeTable':
                            if (!tableName) throw new Error('Nama tabel diperlukan');
                            await fetchTableSchema(tableName);
                            break;
                            
                        case 'queryData':
                            if (!tableName) throw new Error('Nama tabel diperlukan');
                            await executeQuery(`SELECT * FROM ${tableName}`);
                            break;
                            
                        case 'executeSQL':
                            if (!query) throw new Error('Query SQL diperlukan');
                            await executeQuery(query);
                            break;
                            
                        default:
                            throw new Error('Tindakan tidak dikenali');
                    }
                    
                    showSuccess('Operasi berhasil');
                    
                } catch (error) {
                    showError(`Error: ${error.message}`);
                } finally {
                    executeBtn.disabled = false;
                    executeBtn.innerHTML = '<i class="fas fa-play"></i> Eksekusi';
                }
            });
            
            // Test connection
            testBtn.addEventListener('click', async function() {
                try {
                    const result = await callAPI('/health');
                    showSuccess(`✅ Database connected! Status: ${result.status}`);
                } catch (error) {
                    showError(`❌ Connection failed: ${error.message}`);
                }
            });
            
            // Load tables on startup
            fetchTables();
        });
        
        // Helper functions untuk UI
        function showSuccess(message) {
            updateStatus(message, 'success');
            showNotification(message, 'success');
        }
        
        function showError(message) {
            updateStatus(message, 'error');
            showNotification(message, 'error');
        }
        
        function updateStatus(message, level) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${level}`;
        }
        
        function showNotification(message, level) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${level}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }
        
        // Fungsi untuk menampilkan hasil (displayTables, displayTableSchema, etc.)
        // ... implementasi fungsi display seperti sebelumnya ...
    </script>
</body>
</html>
